{% extends "base.html" %}
{% block title %}{% i18n "Storage Pool" %}{% endblock %}
{% block style %}
<link href="/static/css/table-sort.css" rel="stylesheet">
{% endblock %}
{% block content %}
{% include 'sidebar.html' %}
<div class="col-md-9 col-md-offset-2 content">
       {% if error_msg %}
            <script type="text/javascript">
                function ShowAlert() {
                     var title = 'FleetCompute Errors';

                    return eModal
                            .alert('{{ error_msg }}' , title);
                     };
	    </script>	     
     {% endif %}	    
    {% if form.name.errors %}
    <div class="alert alert-danger">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
        {% for error in form.name.errors %}
        <script type="text/javascript">
                function ShowAlert() {
                     var title = 'FleetCompute Errors';

                    return eModal
                              .alert('{{ error }}' , title);
                     };
             </script>
        {% endfor %}
    </div>
    {% endif %}
<br>
<div style="width:100%" class="col-md-10 content">
            <div style="background-color: #eee" class="card ">
              <div style="text-align:left;background-color: #ddd" class="card-header">
                <span class="card-title">Storage</span>
              </div>
              <div class="card-body">

                  <div class='table-responsive'>
                      <table class='table table-condensed'>
                              <tr><th> Name</th><th> Percentage</th><th> State</th><th> Autostart</th><th> Type</th><th> Size</th><th> Usage</th><th> Free</th> </tr>
                              <tr><td>{{ storage.name }}</td>
                              <td>
                              <div class='progress'>
                  <div class="progress-bar progress-bar-danger" role="progressbar" style="width: {{ storage.percent }}%" aria-valuenow=" {{ storage.percent }} " aria-valuemin="0" aria-valuemax="100">{{ storage.percent }}%</div>
                              </div>
                              </td>

                <td>
                    <form action="" method="post" role="form">{% c_csrf_token %}
                        {% if storage.state == 0 %}
                        <input type="submit" class="btn btn-xs btn-default" name="start" value="{% i18n "Start" %}">
                        <input type="submit" class="btn btn-xs btn-default" name="delete" value="{% i18n "Delete" %}"
                               onclick="return confirm('{% i18n "Are you sure?" %}')">
                        {% else %}
                        <input type="submit" class="btn btn-xs btn-default" name="stop" value="{% i18n "Stop" %}"
                               onclick="return confirm('{% i18n "Are you sure?" %}')">
                        {% endif %}
                    </form>
                </td>
                <td>
                    <form action="" method="post" role="form">{% c_csrf_token %}
                        {% if not storage.autostart %}
                        <input type="submit" class="btn btn-xs btn-default" name="set_autostart"
                               value="{% i18n "Enable" %}">
                        {% else %}
                        <input type="submit" class="btn btn-xs btn-default" name="unset_autostart"
                               onclick="return confirm('{% i18n "Are you sure?" %}')" value="{% i18n "Disable" %}">
                        {% endif %}
                    </form>
                </td>
                              <td>{{ storage.type|upper }}</td><td> {{ storage.size }} </td><td> {{ storage.used }}</td><td>{{ storage.sfree }}</td></tr>
                      </table>
                  </div>
                </div>
              <div class="card-footer">
              </div>
            </div>
          </div>
	  <br>
	  <hr>



    {% if storage.state != 0 %}
    {% if storage.name == "iso_images" %}
    <h3>{% i18n "Images" %}</h3>
    <hr>
    {% if storage.state != 0 %}
    <a href="#AddUpload" class="btn btn-primary" data-toggle="modal">{% i18n "Upload ISO" %}</a><br>
    <br>
    {% endif %}

    {% if storage.volumes.size %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="sortTable">
            <thead>
                <tr>
                    <th style="width:35px;">#</th>
                    <th>{% i18n "Name" %}</th>
                    <th style="width:90px;">{% i18n "Size" %}</th>
                    <th style="width:75px;">{% i18n "Format" %}</th>
                    <th colspan="2">{% i18n "Action" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for volume in storage.volumes %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ volume.name }}</td>
                    <td style="width:65px;">{{ volume.size }}<!--|filesizeformat--></td>
                    <td>{{ volume.type }}</td>
                    <td style="width:30px;">
                        <form action="" method="post" role="form">{% c_csrf_token %}
                            <input type="hidden" name="volname" value="{{ volume.name }}">
                            {% if volume.usedby != "" %}
                            <input type="submit" class="btn btn-sm btn-danger disabled" name="del_volume"
                                   value="{% i18n "Delete" %}"
                                   disabled>
                            {% else %}
                            <input type="submit" class="btn btn-sm btn-danger" name="del_volume"
                                   value="{% i18n "Delete" %}"
                                   onclick="return confirm('{% i18n "Are you sure?" %}')">
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="well">
        <h4>{% i18n "You do not have any ISO images or storage pool not active" %}</h4>
    </div>
    {% endif %}
    {% else %}
    <h3>{% i18n "Volumes" %}</h3>
    <hr>
    {% if storage.state != 0 %}
		<a href="#AddImage" class="btn btn-primary" data-toggle="modal">{% i18n "Add Image" %}</a>
    <a href="#AddUpload" class="btn btn-primary" data-toggle="modal">{% i18n "Upload Image" %}</a><br><br>
    {% endif %}
 <div class="clearfix"></div>

    {% if storage.volumes.size %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="sortTable">
            <thead>
                <tr class="active">
                    <th style="width:35px;">#</th>
                    <th>{% i18n "Name" %}</th>
                    <th style="width:80px;">{% i18n "Size" %}</th>
                    <th style="width:75px;">{% i18n "Format" %}</th>
                    <th style="widtg:100px;">{% i18n "Used By" %}</th>
                    <th colspan="3">{% i18n "Action" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for volume in storage.volumes %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ volume.name }}</td>
                    <td style="text-align:right">{{ volume.size }}<!--|filesizeformat--></td>
                    <td>{{ volume.type }}</td>
                    <td>{{ volume.usedby }}</td>
                    <td style="width:30px;">
                        {% if volume.type != "iso" %}
                        <a data-toggle="modal" href="#expand_image"  onclick="expand_image_name('{{ volume.name }}','{{ volume.size }}')"
                           class="btn btn-sm btn-primary">{% i18n "Expand" %}</a>
                        {% else %}
                        <a class="btn btn-sm btn-primary disabled">{% i18n "Expand" %}</a>
                        {% endif %}
                    </td>
                    <td style="width:30px;">
                        <a data-toggle="modal" href="#clone_image"  onclick="clone_image_name('{{ volume.name }}','{{ volume.type }}')"
                           class="btn btn-sm btn-primary">{% i18n "Clone" %}</a>
                    </td>
                    <td style="width:30px;">
                        <form action="" method="post" style="height:10px" role="form">{% c_csrf_token %}
                            {% if volume.usedby != "" %}
                            <input type="submit" class="btn btn-sm btn-danger disabled" name="del_volume"
                                   value="{% i18n "Delete" %}"
                                   disabled>
                            {% else %}
                            <input type="button" class="btn btn-sm btn-danger" name="del_volume"
                                   value="{% i18n "Delete" %}"
				   onclick="callback_delete_image('{{ volume.name }}')">
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="well pagination-centered">
        <h4>{% i18n "You do not have any volumes or storage pools active" %}</h4>
    </div>
    {% endif %}
    {% endif %}
    {% endif %}
 <div class="clearfix"></div>    
{% include '/modal/modal_clone.html' %}
{% include '/modal/modal_file_upload.html' %}
{% include '/modal/modal_add_image.html' %}
{% include '/modal/modal_expand.html' %}
{% endblock %}
{% block script %}
<script>
 $('#volume-convert').on('switchChange.bootstrapSwitch', function (event, state) {
     if ($(this).prop('checked')) {
         $('.format-convert').show();
         if ($('.image-format').val() == 'qcow2') {
             $('.meta-prealloc').show();
         }
     } else {
         $('.format-convert').hide();
         $('.meta-prealloc').hide();
     }
 });
 $(document).on('change', '.image-format', function () {
     if ($(this).val() == "qcow2") {
         $('.meta-prealloc').show();
     } else {
         $('.meta-prealloc').hide();
     }
 });
 {% if storage.type != 'dir' %}
 $('#image_format').hide();
 {% endif %}
</script>
<script src="/static/js/jquery.tablesorter.min.js"></script>
<script src="/static/js/jquery/jquery.form.min.js"></script>
<script>
 $(function() {
     $("#sortTable").tablesorter({
         ignoreCase: true,
         sortList: [[1,0]],
         headers: {4: {sorter: false}},
         textSorter: {1: $.tablesorter.sortText}
     });
 });


$(".modal-header").on("mousedown", function(mousedownEvt) {
    var $draggable = $(this);
    var x = mousedownEvt.pageX - $draggable.offset().left,
        y = mousedownEvt.pageY - $draggable.offset().top;
    $("body").on("mousemove.draggable", function(mousemoveEvt) {
        $draggable.closest(".modal-dialog").offset({
            "left": mousemoveEvt.pageX - x,
            "top": mousemoveEvt.pageY - y
        });
    });
    $("body").one("mouseup", function() {
        $("body").off("mousemove.draggable");
    });
    $draggable.closest(".modal").one("bs.modal.hide", function() {
        $("body").off("mousemove.draggable");
    });
});

function clone_image_name(clone_name,existing_f)
{
  var n1 = document.getElementById('clone_image_from');
  var n3 = document.getElementById('clone_image_to');
  var n2 = document.getElementById('existing-format');
  n1.value = clone_name;
  n2.value = existing_f;
  n3.value = clone_name + '_clone1';
  n1.readOnly = true;
}
    
function expand_image_name(expand_image,existing_s)
{
  var n1 = document.getElementById('expand_image_name');
  var n2 = document.getElementById('existing_size');
  n1.value = expand_image;
  n2.value = existing_s;
  n1.readOnly = true;
  n2.readOnly = true;
}
    
$(function () {
        // window.setInterval('instusage()', {{ time_refresh }});
        if (is_function("ShowAlert")){
              ShowAlert();
          }    
        if (is_function("ShowMessage")){
              ShowMessage();
          }    
    });
     function is_function(func) {
        return typeof window[func] !== 'undefined' && $.isFunction(window[func]);
     }


function callback_delete_image(disk) {
       var disk2remove=disk;
       return eModal
                .confirm('Are you sure to want to delete the ' + disk + ' image?','Attention')
                .then(
                    function () { 
                            var form = document.createElement("form");
                            var element1 = document.createElement("input");
                            var csrf = document.createElement("input");
                            csrf.type="hidden";
                            csrf.value="{{ csrf_token }}";
                            csrf.name="csrfprotectiontoken";
                            form.method = "POST";

                            element1.value=disk2remove;
                            element1.name="del_volume";
                            form.appendChild(element1);
                            form.appendChild(csrf);


                            document.body.appendChild(form);

                            form.submit();

                             }
                    );

  }

</script>
{% endblock %}
